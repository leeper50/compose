networks:
  proxy:
    external: true
volumes:
  n8n_config:
x-common-settings: &common-settings
  logging:
    driver: local
    options:
      compress: "true"
      max-file: "3"
      max-size: "10m"
  restart: unless-stopped
  security_opt:
    - no-new-privileges:true
  stdin_open: false
  tty: false
services:
  n8n:
    <<: *common-settings
    image: docker.n8n.io/n8nio/n8n:${n8n_version:-latest}
    cap_drop:
      - ALL
    container_name: n8n
    environment:
      GENERIC_TIMEZONE: ${timezone:-UTC}
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_HOST: n8n.${domain:?}
      N8N_PORT: 5678
      N8N_PROTOCOL: https
      N8N_PROXY_HOPS: 1
      N8N_RUNNERS_ENABLED: true
      NODE_ENV: production
      TZ: ${timezone:-UTC}
      WEBHOOK_URL: https://n8n.${domain:?}/
    labels:
      kuma.__docker:
      kuma.__web: "n8n.${domain:?}"
      traefik.enable: "true"
      traefik.http.middlewares.n8n.headers.browserXSSFilter: true
      traefik.http.middlewares.n8n.headers.contentTypeNosniff: true
      traefik.http.middlewares.n8n.headers.forceSTSHeader: true
      traefik.http.middlewares.n8n.headers.SSLHost: ${domain:?}
      traefik.http.middlewares.n8n.headers.SSLRedirect: true
      traefik.http.middlewares.n8n.headers.STSIncludeSubdomains: true
      traefik.http.middlewares.n8n.headers.STSPreload: true
      traefik.http.middlewares.n8n.headers.STSSeconds: 315360000
      traefik.http.routers.n8n.entryPoints: "https"
      traefik.http.routers.n8n.middlewares: "n8n@docker"
      traefik.http.routers.n8n.rule: "Host(`n8n.${domain:?}`)"
      traefik.http.services.n8n.loadbalancer.server.url: "http://n8n:5678"
    networks:
      proxy:
    volumes:
      - ${data:-.}/n8n/config:/home/node/.n8n:rw
      - ${data:-.}/n8n/files:/files:rw
