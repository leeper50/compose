networks:
  default: null
  proxy:
    external: true
x-common-settings: &common-settings
  logging:
    driver: local
    options:
      max-size: "10m"
      max-file: "3"
      compress: "true"
  security_opt:
    - no-new-privileges:true
  stdin_open: false
  tty: false
services:
  paperlessngx_broker:
    <<: *common-settings
    image: eqalpha/keydb:${keydb_version:-latest}
    container_name: paperlessngx_broker
    restart: unless-stopped
    cap_drop:
      - ALL
    networks:
      default: null
    volumes:
      - ${data:-.}/keydb:/data
  paperlessngx_db:
    <<: *common-settings
    image: docker.io/library/postgres:${postgres_version:-16}
    container_name: paperlessngx_db
    restart: unless-stopped
    cap_drop:
      - ALL
    networks:
      default: null
    volumes:
      - ${data:-.}/db:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      POSTGRES_PASSWORD: ${db_pass:-paperless}
  paperlessngx:
    <<: *common-settings
    image: ghcr.io/paperless-ngx/paperless-ngx:${paperlessngx_version:-latest}
    container_name: paperlessngx
    restart: unless-stopped
    cap_drop:
      - ALL
    networks:
      proxy: null
      default: null
    depends_on:
      - paperlessngx_db
      - paperlessngx_broker
    labels:
      traefik.enable: "true"
      traefik.http.routers.paperlessngx.entryPoints: "https"
      traefik.http.routers.paperlessngx.middlewares: "allowedIPs@file,authelia@file"
      traefik.http.routers.paperlessngx.rule: "Host(`paper.${domain}`)"
      traefik.http.services.paperlessngx.loadbalancer.server.url: "http://paperlessngx:8000"
    volumes:
      - ${data:-.}/app/data:/usr/src/paperless/data
      - ${data:-.}/app/media:/usr/src/paperless/media
      - ${data:-.}/app/export:/usr/src/paperless/export
      - ${data:-.}/app/consume:/usr/src/paperless/consume
    environment:
      PAPERLESS_REDIS: redis://paperlessngx_broker:6379
      PAPERLESS_DBHOST: paperlessngx_db
      USERMAP_UID: ${uid:-1000}
      USERMAP_GID: ${gid:-1000}
      PAPERLESS_URL: https://paper.${domain}
      PAPERLESS_TIME_ZONE: ${timezone:-UTC}
      PAPERLESS_SECRET_KEY: ${secret_key}
      # Authelia Header SSO
      PAPERLESS_ENABLE_HTTP_REMOTE_USER: true
      PAPERLESS_HTTP_REMOTE_USER_HEADER_NAME: HTTP_REMOTE_USER
      PAPERLESS_LOGOUT_REDIRECT_URL: https://auth.${domain}/logout
