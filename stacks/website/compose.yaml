networks:
  mywebsite: null
  freshrss: null
  proxy:
    external: true
x-common-settings: &common-settings
  logging:
    driver: local
    options:
      max-size: "10m"
      max-file: "3"
      compress: "true"
  restart: unless-stopped
  security_opt:
    - no-new-privileges:true
  stdin_open: false
  tty: false
services:
  mywebsite:
    <<: *common-settings
    image: dellhplaptop/newwebsite:${mywebsite_version:-latest}
    container_name: mywebsite
    user: ${uid:-1000}:${gid:-1000}
    cap_drop:
      - ALL
    networks:
      proxy:
    volumes:
      - ${data:-.}/newweb/db:/app/db
    labels:
      traefik.enable: "true"
      traefik.http.routers.mywebsite.entryPoints: "https"
      traefik.http.routers.mywebsite.middlewares: "allowedIPs@file"
      traefik.http.routers.mywebsite.rule: "Host(`${domain:?}`) || Host(`www.${domain:?}`)"
      traefik.http.services.mywebsite.loadbalancer.server.url: "http://mywebsite:8080"
  freshrss:
    <<: *common-settings
    image: freshrss/freshrss:${freshrss_version:-latest}
    container_name: freshrss
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    depends_on:
      - freshrssdb
    networks:
      proxy:
      freshrss:
    logging:
      options:
        max-size: 10m
    volumes:
      - ${data:-.}/rss/data:/var/www/FreshRSS/data
      - ${data:-.}/rss/extensions:/var/www/FreshRSS/extensions
    environment:
      TZ: ${timezone:-UTC}
      TRUSTED_PROXY: 0
      LISTEN: 0.0.0.0:80
      CRON_MIN: "1,31"
    labels:
      traefik.enable: "true"
      traefik.http.routers.freshrss.entryPoints: "https"
      traefik.http.routers.freshrss.middlewares: "allowedIPs@file,authelia@file"
      traefik.http.routers.freshrss.rule: "Host(`fr.${domain:?}`)"
      traefik.http.services.freshrss.loadbalancer.server.url: "http://freshrss:80"
  freshrssdb:
    <<: *common-settings
    image: postgres:${postgres_version:-16}
    container_name: freshrssdb
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_READ_SEARCH
      - FOWNER
      - SETGID
      - SETUID
    networks:
      freshrss:
    volumes:
      - ${data:-.}/rss/db:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${db_name:-freshrss}
      POSTGRES_PASSWORD: ${db_pass:?}
      POSTGRES_USER: ${db_user:-freshrss}
  vaultwarden:
    <<: *common-settings
    image: vaultwarden/server:${vaultwarden_version:-latest}
    container_name: vaultwarden
    cap_drop:
      - ALL
    networks:
      proxy:
    environment:
      DOMAIN: https://vault.${domain:?}
      ADMIN_TOKEN: "${vaultwarden_admin_token:?}"
    volumes:
      - ${data:-.}/vault/data:/data
    labels:
      traefik.enable: "true"
      traefik.http.routers.vaultwarden.entryPoints: "https"
      traefik.http.routers.vaultwarden.middlewares: "allowedIPs@file"
      traefik.http.routers.vaultwarden.rule: "Host(`vault.${domain:?}`)"
      traefik.http.routers.vaultwarden.priority: 30
      traefik.http.services.vaultwarden.loadbalancer.server.url: "http://vaultwarden:80"
      # Block admin page with authelia
      traefik.http.routers.vaultwarden-admin.entrypoints: "https"
      traefik.http.routers.vaultwarden-admin.middlewares: "allowedIPs@file,authelia@file"
      traefik.http.routers.vaultwarden-admin.priority: 50
      traefik.http.routers.vaultwarden-admin.rule: Host(`vault.${domain:?}`) && PathPrefix(`/admin`)
  homepage:
    <<: *common-settings
    image: ghcr.io/gethomepage/homepage:${homepage_version:-latest}
    container_name: homepage
    cap_drop:
      - ALL
    networks:
      proxy:
    environment:
      TZ: ${timezone:-UTC}
      HOMEPAGE_ALLOWED_HOSTS: home.${domain:?}
    volumes:
      - ${data:-.}/homepage:/app/config:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.homepage.entryPoints: "https"
      traefik.http.routers.homepage.middlewares: "localonly@file"
      traefik.http.routers.homepage.rule: "Host(`home.${domain:?}`)"
      traefik.http.services.homepage.loadbalancer.server.url: "http://homepage:3000"
  copyparty:
    <<: *common-settings
    image: copyparty/iv:${copyparty_version:-latest}
    container_name: copyparty
    user: ${uid:-1000}:${gid:-1000}
    cap_drop:
      - ALL
    networks:
      proxy:
    environment:
      LD_PRELOAD: /usr/lib/libmimalloc-secure.so.2
    volumes:
      - ${data:-.}/copyparty/conf:/cfg
      - ${data:-.}/copyparty/files:/w
    labels:
      traefik.enable: "true"
      traefik.http.routers.copyparty.entryPoints: "https"
      traefik.http.routers.copyparty.middlewares: "localonly@file"
      traefik.http.routers.copyparty.rule: "Host(`c.${domain:?}`)"
      traefik.http.services.copyparty.loadbalancer.server.url: "http://copyparty:3923"
    stop_grace_period: 15s # thumbnailer is allowed to continue finishing up for 10s after the shutdown signal
    healthcheck:
      # hide it from logs with "/._" so it matches the default --lf-url filter
      test: ["CMD-SHELL", "wget --spider -q 127.0.0.1:3923/?reset=/._"]
      interval: 1m
      timeout: 2s
      retries: 5
      start_period: 15s
