networks:
  default: null
  proxy:
    external: true
x-common-settings: &common-settings
  logging:
    driver: local
    options:
      compress: "true"
      max-file: "3"
      max-size: "10m"
  restart: unless-stopped
  security_opt:
    - no-new-privileges:true
  stdin_open: false
  tty: false
services:
  crowdsec:
    <<: *common-settings
    cap_drop:
      - ALL
    container_name: crowdsec
    environment:
      GID: ${gid:-1000}
      COLLECTIONS: "crowdsecurity/linux crowdsecurity/traefik"
    image: crowdsecurity/crowdsec:${crowdsec_version:-latest}
    labels:
      kuma.__docker:
    networks:
      proxy:
    volumes:
      - ${data:-.}/crowdsec/db:/var/lib/crowdsec/data/
      - ${data:-.}/crowdsec/config:/etc/crowdsec/
      - ${data:-.}/logs/crowdsec:/var/log:ro
  geoipfilter:
    <<: *common-settings
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
    container_name: geoipfilter
    environment:
      MAXMIND_ID: ${maxmind_id:?}
      MAXMIND_KEY: ${maxmind_key:?}
      FILTER_TYPE: ${filter:-allow}
      COUNTRY_CODES: ${country_codes:-US}
      BLOCK_STATUS_CODE: ${block_status_code:-418}
      EXTRA_IPS: 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
    image: mpdcampbell/traefik-geoip-filter:${geoip_version:-latest}
    labels:
      kuma.__docker:
    networks:
      proxy:
    volumes:
      - ${data:-.}/geoip:/geoip
  pocketid:
    <<: *common-settings
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    container_name: pocketid
    environment:
      APP_URL: https://id.${domain}
      ENCRYPTION_KEY: ${pocketid_enc_key:?}
      PGID: ${gid:-1000}
      PUID: ${uid:-1000}
      TRUST_PROXY: true
    healthcheck:
      interval: 1m30s
      retries: 2
      start_period: 10s
      test: [ "CMD", "/app/pocket-id", "healthcheck" ]
      timeout: 5s
    image: ghcr.io/pocket-id/pocket-id:${pocketid_version:-v2}
    labels:
      kuma.__docker:
      kuma.__web: '"id.${domain:?}"'
      traefik.enable: "true"
      traefik.http.routers.pocketid.entryPoints: "https"
      traefik.http.routers.pocketid.rule: "Host(`id.${domain:?}`)"
    networks:
      proxy:
    volumes:
      - ${data:-.}/pocketid:/app/data
  tinyauth:
    <<: *common-settings
    cap_drop:
      - ALL
    container_name: tinyauth
    depends_on:
      - pocketid
    environment:
      APP_URL: https://auth.${domain}
      OAUTH_AUTO_REDIRECT: pocketid
      PROVIDERS_POCKETID_AUTH_URL: https://id.${domain}/authorize
      PROVIDERS_POCKETID_CLIENT_ID: ${tinyauth_id}
      PROVIDERS_POCKETID_CLIENT_SECRET: ${tinyauth_secret}
      PROVIDERS_POCKETID_NAME: Pocket ID
      PROVIDERS_POCKETID_REDIRECT_URL: https://auth.${domain}/api/oauth/callback/pocketid
      PROVIDERS_POCKETID_SCOPES: openid email profile groups
      PROVIDERS_POCKETID_TOKEN_URL: https://id.${domain}/api/oidc/token
      PROVIDERS_POCKETID_USER_INFO_URL: https://id.${domain}/api/oidc/userinfo
    image: ghcr.io/steveiliop56/tinyauth:${tinyauth_version:-v4}
    labels:
      kuma.__docker:
      kuma.__web: '"auth.${domain:?}"'
      traefik.enable: "true"
      traefik.http.routers.tinyauth.entryPoints: "https"
      traefik.http.routers.tinyauth.rule: "Host(`auth.${domain:?}`)"
    networks:
      proxy:
  traefik:
    <<: *common-settings
    cap_drop:
      - ALL
    container_name: traefik
    depends_on:
      - crowdsec
      - geoipfilter
      - pocketid
    environment:
      CF_DNS_API_TOKEN: ${cf_dns_api_token:?}
      TRAEFIK_DASHBOARD_CREDENTIALS: ${TRAEFIK_DASHBOARD_CREDENTIALS:?}
    image: traefik:${traefik_version:-v3.6}
    labels:
      kuma.__docker:
      kuma.__web: '"tf.${domain:?}"'
      traefik.enable: "true"
      traefik.http.routers.traefik.entryPoints: "https"
      traefik.http.routers.traefik.middlewares: "localonly@file"
      traefik.http.routers.traefik.rule: "Host(`tf.${domain:?}`)"
      traefik.http.routers.traefik.service: "api@internal"
      traefik.http.services.traefik.loadbalancer.server.url: "http://traefik:8080"
    networks:
      proxy:
    ports:
      - "80:80/tcp"
      - "443:443/tcp"
      - "443:443/udp"
      - "25565:25565/tcp"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${data:-.}/traefik/traefik.yml:/traefik.yml:ro
      - ${data:-.}/traefik/dynamic.yml:/dynamic.yml:ro
      - ${data:-.}/traefik/acme.json:/acme.json:rw
      - ${data:-.}/logs/traefik:/var/log/traefik:rw
  vector:
    <<: *common-settings
    cap_drop:
      - ALL
    command: ["--config", "/etc/vector/vector.yaml"]
    container_name: vector
    depends_on:
      - crowdsec
    image: timberio/vector:${vector_version:-latest-alpine}
    labels:
      kuma.__docker:
    networks:
      default:
    volumes:
      - ${data:-.}/logs:/var/log
      - ${data:-.}/vector:/etc/vector:ro
