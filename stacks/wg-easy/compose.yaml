networks:
  proxy:
    external: true
x-common-settings: &common-settings
  logging:
    driver: local
    options:
      max-size: "10m"
      max-file: "3"
      compress: "true"
  restart: unless-stopped
  security_opt:
    - no-new-privileges:true
  stdin_open: false
  tty: false
services:
  wgeasy:
    <<: *common-settings
    image: ghcr.io/wg-easy/wg-easy:${wgeasy_version:-15}
    container_name: wgeasy
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1
    networks:
      proxy:
    ports:
      - 51820:51820/udp
    environment:
      INSECURE: false
    volumes:
      - ${data:-.}/wg-easy:/etc/wireguard
      - /lib/modules:/lib/modules:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.wgeasy.entryPoints: "https"
      traefik.http.routers.wgeasy.middlewares: "localonly@file"
      traefik.http.routers.wgeasy.rule: "Host(`vpn.${domain}`)"
      traefik.http.services.wgeasy.loadbalancer.server.url: "http://wgeasy:51821"
