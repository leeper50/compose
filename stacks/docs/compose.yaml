networks:
  bookstack: null
  proxy:
    external: true
x-common-settings: &common-settings
  logging:
    driver: local
    options:
      max-size: "10m"
      max-file: "3"
      compress: "true"
  security_opt:
    - no-new-privileges:true
  stdin_open: false
  tty: false
services:
  # Wiki service
  bookstack:
    <<: *common-settings
    image: lscr.io/linuxserver/bookstack:${bookstack_version:-latest}
    container_name: bookstack
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_READ_SEARCH
      - FOWNER
      - SETGID
      - SETUID
    depends_on:
      - bookstack_db
    networks:
      bookstack: null
      proxy: null
    environment:
      TZ: ${timezone:-UTC}
      APP_DEBUG: true
      APP_URL: https://wiki.${domain}
      APP_KEY: ${app_key}
      DB_HOST: bookstack_db
      DB_PORT: 3306
      DB_DATABASE: bookstack
      DB_USERNAME: bookstack
      DB_PASSWORD: ${db_pass}
      QUEUE_CONNECTION: null
    volumes:
      - ${data:-.}/bookstack/config:/config:rw
    labels:
      traefik.enable: "true"
      traefik.http.routers.bookstack.entryPoints: "https"
      traefik.http.routers.bookstack.middlewares: "localonly@file"
      traefik.http.routers.bookstack.rule: "Host(`wiki.${domain}`)"
      traefik.http.services.bookstack.loadbalancer.server.url: "http://bookstack:80"
  bookstack_db:
    <<: *common-settings
    image: lscr.io/linuxserver/mariadb:${mariadb_version:-latest}
    container_name: bookstack_db
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_READ_SEARCH
      - FOWNER
      - SETGID
      - SETUID
    networks:
      bookstack: null
    environment:
      TZ: ${timezone:-UTC}
      MYSQL_ROOT_PASSWORD: ${root_pass}
      MYSQL_DATABASE: bookstack
      MYSQL_USER: bookstack
      MYSQL_PASSWORD: ${db_pass}
    volumes:
      - ${data:-.}/bookstack/db:/config:rw
  ntfy:
    image: binwiederhier/ntfy:${ntfy_version:-latest}
    container_name: ntfy
    user: ${uid:-1000}:${gid:-1000}
    restart: unless-stopped
    cap_drop:
      - ALL
    init: true
    command:
      - serve
    networks:
      proxy: null
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1",
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      TZ: ${timezone:-UTC}
      NTFY_BASE_URL: https://n.${domain}
      NTFY_AUTH_DEFAULT_ACCESS: deny-all
      NTFY_BEHIND_PROXY: true
      NTFY_ENABLE_LOGIN: true
      NTFY_CACHE_FILE: /var/lib/ntfy/cache.db
      NTFY_AUTH_FILE: /var/lib/ntfy/auth.db
      NTFY_ATTACHMENT_CACHE_DIR: /var/lib/ntfy/attachments
      NTFY_UPSTREAM_BASE_URL: https://ntfy.sh
    volumes:
      - ${data:-.}/ntfy/data:/var/lib/ntfy
    labels:
      traefik.enable: "true"
      traefik.http.routers.ntfy.entryPoints: "https"
      traefik.http.routers.ntfy.middlewares: "localonly@file"
      traefik.http.routers.ntfy.rule: "Host(`n.${domain}`)"
      traefik.http.services.ntfy.loadbalancer.server.url: "http://ntfy:80"
  # Metrics service
  grafana:
    <<: *common-settings
    image: grafana/grafana:${grafana_version:-latest}
    container_name: grafana
    user: ${uid:-1000}:${gid:-1000}
    restart: unless-stopped
    cap_drop:
      - ALL
    depends_on:
      - prometheus
    networks:
      proxy: null
    environment:
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource,grafana-worldmap-panel,grafana-piechart-panel
    volumes:
      - ${data:-.}/grafana:/var/lib/grafana
      - /etc/timezone:/etc/timezone:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.grafana.entryPoints: "https"
      traefik.http.routers.grafana.middlewares: "localonly@file"
      traefik.http.routers.grafana.rule: "Host(`gf.${domain}`)"
      traefik.http.services.grafana.loadbalancer.server.url: "http://grafana:3000"
  prometheus:
    <<: *common-settings
    image: prom/prometheus:${prometheus_version:-latest}
    container_name: prometheus
    restart: unless-stopped
    cap_drop:
      - ALL
    networks:
      proxy: null
    volumes:
      - ${data:-.}/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ${data:-.}/prometheus/data:/prometheus
      - /etc/timezone:/etc/timezone:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.prometheus.entryPoints: "https"
      traefik.http.routers.prometheus.middlewares: "localonly@file"
      traefik.http.routers.prometheus.rule: "Host(`pm.${domain}`)"
      traefik.http.services.prometheus.loadbalancer.server.url: "http://prometheus:9090"
  # Uptime service
  uptimekuma:
    <<: *common-settings
    image: louislam/uptime-kuma:${uptimekuma_version:-2}
    container_name: uptimekuma
    restart: unless-stopped
    cap_drop:
      - ALL
    networks:
      proxy: null
    volumes:
      - ${data:-.}/uptime:/app/data:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.uptimekuma.entryPoints: "https"
      traefik.http.routers.uptimekuma.middlewares: "localonly@file"
      traefik.http.routers.uptimekuma.rule: "Host(`up.${domain}`)"
      traefik.http.services.uptimekuma.loadbalancer.server.url: "http://uptimekuma:3001"
