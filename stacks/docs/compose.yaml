networks:
  bookstack: null
  proxy:
    external: true
x-logging-policy: &logging-policy
  logging:
    driver: local
    options:
      max-size: "10m"
      max-file: "3"
      compress: "true"
services:
  # Wiki service
  bookstack:
    <<: *logging-policy
    image: lscr.io/linuxserver/bookstack:${bookstack_version:-latest}
    container_name: bookstack
    restart: unless-stopped
    depends_on:
      - bookstack_db
    networks:
      bookstack: null
      proxy: null
    environment:
      TZ: ${timezone:-UTC}
      PUID: ${uid:-1000}
      PGID: ${gid:-1000}
      APP_DEBUG: true
      APP_URL: https://wiki.${domain}
      APP_KEY: ${app_key}
      DB_HOST: bookstack_db
      DB_PORT: 3306
      DB_DATABASE: bookstack
      DB_USERNAME: bookstack
      DB_PASSWORD: ${db_pass}
      QUEUE_CONNECTION: null
    volumes:
      - ${data:-.}/bookstack/config:/config
    labels:
      traefik.enable: "true"
      traefik.http.routers.bookstack.entryPoints: "https"
      traefik.http.routers.bookstack.middlewares: "localonly@file"
      traefik.http.routers.bookstack.rule: "Host(`wiki.${domain}`)"
      traefik.http.routers.bookstack.tls.certresolver: "cloudflare"
      traefik.http.services.bookstack.loadbalancer.server.url: "http://bookstack:80"
  bookstack_db:
    <<: *logging-policy
    image: lscr.io/linuxserver/mariadb:${mariadb_version:-latest}
    container_name: bookstack_db
    restart: unless-stopped
    networks:
      bookstack: null
    environment:
      TZ: ${timezone:-UTC}
      PUID: ${uid:-1000}
      PGID: ${gid:-1000}
      MYSQL_ROOT_PASSWORD: ${root_pass}
      MYSQL_DATABASE: bookstack
      MYSQL_USER: bookstack
      MYSQL_PASSWORD: ${db_pass}
    volumes:
      - ${data:-.}/bookstack/db:/config

  # Metrics service
  grafana:
    <<: *logging-policy
    image: grafana/grafana:${grafana_version:-latest}
    container_name: grafana
    restart: always
    depends_on:
      - prometheus
    user: ${uid:-1000}
    security_opt:
      - no-new-privileges:true
    networks:
      proxy: null
    environment:
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource,grafana-worldmap-panel,grafana-piechart-panel
    volumes:
      - ${data:-.}/grafana:/var/lib/grafana
      - /etc/timezone:/etc/timezone:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.grafana.entryPoints: "https"
      traefik.http.routers.grafana.middlewares: "localonly@file"
      traefik.http.routers.grafana.rule: "Host(`gf.${local_domain}`)"
      traefik.http.routers.grafana.tls.certresolver: "cloudflare"
      traefik.http.services.grafana.loadbalancer.server.url: "http://grafana:3000"
  prometheus:
    <<: *logging-policy
    image: prom/prometheus:${prometheus_version:-latest}
    container_name: prometheus
    restart: always
    networks:
      proxy: null
    volumes:
      - ${data:-.}/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - /etc/timezone:/etc/timezone:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.prometheus.entryPoints: "https"
      traefik.http.routers.prometheus.middlewares: "localonly@file"
      traefik.http.routers.prometheus.rule: "Host(`pm.${local_domain}`)"
      traefik.http.routers.prometheus.tls.certresolver: "cloudflare"
      traefik.http.services.prometheus.loadbalancer.server.url: "http://prometheus:9090"

  # Uptime service
  uptimekuma:
    <<: *logging-policy
    image: louislam/uptime-kuma:${uptimekuma_version:-latest}
    container_name: uptimekuma
    restart: always
    networks:
      proxy: null
    volumes:
      - ${data:-.}/uptime:/app/data:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.uptimekuma.entryPoints: "https"
      traefik.http.routers.uptimekuma.middlewares: "localonly@file"
      traefik.http.routers.uptimekuma.rule: "Host(`up.${domain}`)"
      traefik.http.routers.uptimekuma.tls.certresolver: "cloudflare"
      traefik.http.services.uptimekuma.loadbalancer.server.url: "http://uptimekuma:3001"
